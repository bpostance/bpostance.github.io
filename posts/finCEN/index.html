<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="The finCEN files: Uncovering money laundering patterns in the global banking network" /><meta name="author" content="Ben Postance" /><meta property="og:locale" content="en_US" /><meta name="description" content="Risk, Data Science and Machine Learning" /><meta property="og:description" content="Risk, Data Science and Machine Learning" /><link rel="canonical" href="https://bpostance.github.io/posts/finCEN/" /><meta property="og:url" content="https://bpostance.github.io/posts/finCEN/" /><meta property="og:site_name" content="Ben Postance" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-09-21T19:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="The finCEN files: Uncovering money laundering patterns in the global banking network" /><meta name="twitter:site" content="@benpostance" /><meta name="twitter:creator" content="@Ben Postance" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ben Postance"},"dateModified":"2025-02-12T12:34:19+00:00","datePublished":"2020-09-21T19:00:00+01:00","description":"Risk, Data Science and Machine Learning","headline":"The finCEN files: Uncovering money laundering patterns in the global banking network","mainEntityOfPage":{"@type":"WebPage","@id":"https://bpostance.github.io/posts/finCEN/"},"url":"https://bpostance.github.io/posts/finCEN/"}</script><title>The finCEN files: Uncovering money laundering patterns in the global banking network | Ben Postance</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> // see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> MathJax = { tex: { inlineMath: [ // start/end delimiter pairs for in-line math ['$','$'], ['\\(','\\)'] ], displayMath: [ // start/end delimiter pairs for display math ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-140894462-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-140894462-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="top"></div><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/7165735?s=460&u=7ca34b8152bbff087bfc860cc87a4c35b4f9cb1b&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ben Postance</a></div><div class="site-subtitle font-italic">Risk, Data Science and Machine Learning</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/bpostance" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/benpostance" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['benpostance','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>The finCEN files: Uncovering money laundering patterns in the global banking network</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>The finCEN files: Uncovering money laundering patterns in the global banking network</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Ben Postance </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Sep 21, 2020, 7:00 PM +0100" prep="on" > Sep 21, 2020 <i class="unloaded">2020-09-21T19:00:00+01:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Feb 12, 2025, 12:34 PM +0000" prefix="Updated " > Feb 12 <i class="unloaded">2025-02-12T12:34:19+00:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1240 words">6 min</span></div></div><div class="post-content"> <center><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://upload.wikimedia.org/wikipedia/commons/c/c2/FinCEN.svg" width="250" height="250" /></center><p><strong><a href="https://github.com/bpostance/dsc.learn/blob/main/Graph/00-misc/finCEN.ipynb">Jupyter notebook here</a></strong> The Financial Crimes Enforcement Network (finCEN) files are more than 2,500 documents, most of which were suspicious activity reports (SARs) files that banks sent to the US authorities between 2000 and 2017. The SARs document the flow of $2 trillion of transactions between some of the world’s biggest banks. Whilst SARs are filed by bank compliance officers, and are therefore not necessarily evidence of wrongdoing by themselves. The leaked documents raise concerns about what the banks clients might be doing and how global banking jurisdictions facilitate money laundering at global scale.</p><p>These documents are some of the international banking system’s most closely guarded secrets. Banks use them to report suspicious behaviour but they are not proof of wrongdoing or crime. They were leaked to Buzzfeed News and shared with a group that brings together investigative journalists from around the world, which distributed them to 108 news organisations in 88 countries, including the BBC’s Panorama programme. Hundreds of journalists have been sifting through the dense, technical documentation, uncovering some of the activities that banks would prefer the public not to know about.<a href="https://www.bbc.co.uk/news/uk-54226107">BBC</a></p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">re</span>
<span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="n">requests</span><span class="p">,</span> <span class="n">zipfile</span><span class="p">,</span> <span class="n">io</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">plt</span><span class="p">.</span><span class="n">rcParams</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">'</span><span class="s">font.size</span><span class="sh">'</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
</pre></table></code></div></div><h1 id="download-extract-and-load-data">Download, Extract, and Load data</h1><p>There are two data tables:</p><ol><li>Connections: detailing Bank’s by territory that are related to one another by finCEN reported transactions.<li>Transactions: detailing the transaction counts and value ($) between banks and intermediaries.</ol><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c1"># download and extract zip file
</span><span class="n">zip_file_url</span> <span class="o">=</span> <span class="sh">'</span><span class="s">https://media.icij.org/uploads/2020/09/download_data_fincen_files.zip</span><span class="sh">'</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">zip_file_url</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">zipfile</span><span class="p">.</span><span class="nc">ZipFile</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="nc">BytesIO</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">content</span><span class="p">))</span>
<span class="n">z</span><span class="p">.</span><span class="nf">extractall</span><span class="p">(</span><span class="sh">"</span><span class="s">./data/fincen</span><span class="sh">"</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1"># load data
# methods to extract str between patterns https://stackoverflow.com/a/4917004/4538066
</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sh">'</span><span class="s">download_(.+?).csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">f</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span><span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="sh">'</span><span class="s">utf-8-sig</span><span class="sh">'</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="sh">'</span><span class="s">./data/fincen</span><span class="sh">'</span><span class="p">,</span> <span class="sh">"</span><span class="s">*.csv</span><span class="sh">"</span><span class="p">))}</span>
<span class="n">data</span><span class="p">.</span><span class="nf">keys</span><span class="p">()</span>
</pre></table></code></div></div><h1 id="data-transforms">Data Transforms</h1><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">connecitons</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">bank_connections</span><span class="sh">'</span><span class="p">]</span>
<span class="n">connecitons</span><span class="p">[</span><span class="sh">'</span><span class="s">filer_org_name</span><span class="sh">'</span><span class="p">].</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">Soci�t� G�n�rale SA</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">Societe Generale SA</span><span class="sh">'</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">transactions</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">transactions_map</span><span class="sh">'</span><span class="p">]</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1"># create clean name columm
</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">filer_org_name</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">originator_bank</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">beneficiary_bank</span><span class="sh">'</span><span class="p">,]</span>
<span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span> 
    <span class="n">transactions</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">nm</span><span class="si">}</span><span class="s">_</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">transactions</span><span class="p">[</span><span class="n">nm</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="nf">upper</span><span class="p">().</span><span class="nb">str</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="s">(?i)[^a-z&amp;0-9 ]</span><span class="sh">'</span><span class="p">,</span><span class="sh">''</span><span class="p">).</span><span class="nb">str</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>
    
<span class="c1"># can't have 0 transactions if amount exists
</span><span class="n">transactions</span><span class="p">[</span><span class="sh">'</span><span class="s">number_transactions</span><span class="sh">'</span><span class="p">].</span><span class="nf">replace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">o_num</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">transactions_map</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">originator_bank_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())</span>
<span class="n">f_num</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">transactions_map</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">filer_org_name_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())</span>
<span class="n">b_num</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">transactions_map</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">beneficiary_bank_id</span><span class="sh">'</span><span class="p">].</span><span class="nf">unique</span><span class="p">())</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Originators:</span><span class="se">\t</span><span class="si">{</span><span class="n">o_num</span><span class="si">}</span><span class="se">\n</span><span class="s">Filers:</span><span class="se">\t\t</span><span class="si">{</span><span class="n">f_num</span><span class="si">}</span><span class="se">\n</span><span class="s">Benficiaries:</span><span class="se">\t</span><span class="si">{</span><span class="n">b_num</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>Originators:	892
Filers:		26
Benficiaries:	1392
</pre></table></code></div></div><h1 id="explore-the-data">Explore the data</h1><p><strong><em>Transaction Values between Originator and Beneficiary countries</em></strong></p><p>The heatmap below illustrate patterns of suspicious transactions occurring both within and between countries. Interesting patterns are shown including between politically linked former USSR countries Latvia and Russia, and Great Britain and self-governing British oversees territory The Cayman Islands (right). The top countries (left) that are both sending and receiving high volumes and values of suspicious transactions include:</p><ul><li>Latvia<li>Russia<li>Switzerland<li>The Netherlands<li>Singapore<li>Great Britain</ul><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="n">fig</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="c1"># calculate flow between ISO countries
</span><span class="n">iso_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">crosstab</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">transactions_map</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">beneficiary_iso</span><span class="sh">'</span><span class="p">],</span>
                         <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">transactions_map</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">originator_iso</span><span class="sh">'</span><span class="p">],</span>
                         <span class="n">values</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">transactions_map</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">amount_transactions</span><span class="sh">'</span><span class="p">],</span><span class="n">aggfunc</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">)</span>
<span class="n">iso_matrix</span> <span class="o">=</span> <span class="n">iso_matrix</span><span class="p">.</span><span class="nf">dropna</span><span class="p">(</span><span class="n">thresh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="nf">dropna</span><span class="p">(</span><span class="n">thresh</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># filter results to top n crossovers
</span><span class="n">iso_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="n">iso_matrix</span><span class="o">/</span><span class="mi">1000000</span><span class="p">).</span><span class="nf">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="c1"># make $ values in Millions
</span>
<span class="c1"># sort by total x (originator)
</span><span class="n">iso_matrix</span> <span class="o">=</span> <span class="n">iso_matrix</span><span class="p">[</span><span class="n">iso_matrix</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="nf">sort_values</span><span class="p">().</span><span class="n">index</span><span class="p">]</span>

<span class="c1"># sort by total y (benficiary)
</span><span class="n">iso_matrix</span> <span class="o">=</span> <span class="n">iso_matrix</span><span class="p">.</span><span class="nf">assign</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="n">iso_matrix</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)).</span><span class="nf">sort_values</span><span class="p">(</span><span class="sh">'</span><span class="s">sort</span><span class="sh">'</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="nf">drop</span><span class="p">(</span><span class="sh">'</span><span class="s">sort</span><span class="sh">'</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># plot heatmap
</span><span class="n">n</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">iso_matrix</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">n</span><span class="p">,</span><span class="o">-</span><span class="n">n</span><span class="p">:],</span><span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">Reds</span><span class="sh">'</span><span class="p">,</span><span class="n">cbar</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="sh">'</span><span class="s">.0f</span><span class="sh">'</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">heatmap</span><span class="p">(</span><span class="n">iso_matrix</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="sh">'</span><span class="s">Reds</span><span class="sh">'</span><span class="p">,</span><span class="n">linewidths</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="sh">'</span><span class="s">.0f</span><span class="sh">'</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">"</span><span class="s">size</span><span class="sh">"</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">label</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">Transaction Value ($ M)</span><span class="sh">'</span><span class="p">})</span>

<span class="c1"># fix y axis limits
</span><span class="k">for</span> <span class="n">ax</span><span class="p">,</span><span class="n">title</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,[</span><span class="sa">f</span><span class="sh">'</span><span class="s">Top </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s"> Countries</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">All Countries</span><span class="sh">'</span><span class="p">]):</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">ax</span><span class="p">.</span><span class="nf">get_ylim</span><span class="p">()</span> <span class="c1"># discover the values for bottom and top
</span>    <span class="n">b</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="c1"># Add 0.5 to the bottom
</span>    <span class="n">t</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="c1"># Subtract 0.5 from the top
</span>    <span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2020-09-21-finCEN/output_11_0.png" alt="png" /></p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1"># Cluster example
# pairwise_ dist
</span></pre></table></code></div></div><p><strong><em>Transaction chains between originators, filers, and beneficiaries</em></strong></p><p>The transaction chains highlight the parties initiating and facilitating payments. Below are the top 3 transaction chains by value and by volume of transactions.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">originator_bank_</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">filer_org_name_</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">beneficiary_bank_</span><span class="sh">'</span><span class="p">]</span>
<span class="n">transaction_chains</span> <span class="o">=</span> <span class="n">transactions</span><span class="p">.</span><span class="nf">groupby</span><span class="p">(</span><span class="n">cols</span><span class="p">).</span><span class="nf">agg</span><span class="p">({</span><span class="sh">'</span><span class="s">number_transactions</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">,</span>
                                                     <span class="sh">'</span><span class="s">amount_transactions</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">}).</span><span class="nf">reset_index</span><span class="p">()</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1"># top chains in terms of transcation value
</span><span class="n">transaction_chains</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">by</span><span class="o">=</span><span class="sh">'</span><span class="s">amount_transactions</span><span class="sh">'</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
</pre></table></code></div></div><div><style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; }</style><table border="1" class="dataframe"><thead><tr style="text-align: right;"><th><th>originator_bank_<th>filer_org_name_<th>beneficiary_bank_<th>number_transactions<th>amount_transactions<tbody><tr><th>102<td>AMSTERDAM TRADE BANK NV<td>THE BANK OF NEW YORK MELLON CORP<td>ROSBANK<td>4.0<td>2.747023e+09<tr><th>1985<td>RIGENSIS BANK AS<td>DEUTSCHE BANK AG<td>ING NETHERLAND NV<td>47.0<td>1.201172e+09<tr><th>1347<td>ING NETHERLAND NV<td>DEUTSCHE BANK AG<td>RIGENSIS BANK AS<td>33.0<td>1.199220e+09</table></div><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1"># top chains in terms of transaction number.
# Bank of New York Mellon
</span><span class="n">transaction_chains</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="sh">'</span><span class="s">number_transactions</span><span class="sh">'</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
</pre></table></code></div></div><div><style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; }</style><table border="1" class="dataframe"><thead><tr style="text-align: right;"><th><th>originator_bank_<th>filer_org_name_<th>beneficiary_bank_<th>number_transactions<th>amount_transactions<tbody><tr><th>139<td>AS EXPOBANK<td>THE BANK OF NEW YORK MELLON CORP<td>CREDIT SUISSE AG<td>296.0<td>8.880407e+08<tr><th>101<td>AMSTERDAM TRADE BANK NV<td>STANDARD CHARTERED PLC<td>RAIFFEISEN BANK INTERNATIONAL AG<td>190.0<td>4.026005e+08<tr><th>701<td>CIMB BANK BERHAD<td>THE BANK OF NEW YORK MELLON CORP<td>BARCLAYS BANK PLC<td>186.0<td>1.731369e+08</table></div><p>We can employ several analytical and visualisation techniques to more easily inpsect and unpick the transaction chains. This includes <a href="https://plotly.com/python/sankey-diagram/">flow and Sankey diagrams</a>, and <a href="">network analyses</a>.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1">#quantile = transaction_chains.groupby(cols)['amount_transactions'].sum().quantile(q=0.9)
</span><span class="n">filtered</span> <span class="o">=</span> <span class="n">transaction_chains</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="sh">'</span><span class="s">number_transactions</span><span class="sh">'</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)[:</span><span class="mi">50</span><span class="p">]</span>
</pre></table></code></div></div><p>Here is A funciton to convert any edge list to the Plotly Sankey diagram format. I have created a <a href="https://gist.github.com/bpostance/ecca4bc3ce4477c274fdf9282a4c8223">gist here</a>.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">df_2_sankey</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">cols</span><span class="p">,</span><span class="n">values</span><span class="p">,</span><span class="n">hover_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s"> Helper function to convert a dataframe of relationships to 
        Plotly Sankey format.
    </span><span class="sh">"""</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">#D0EDA6</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">#EDEF7B</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">#EF7B84</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">#00308f</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">#eedc82</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">#c66</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
    <span class="n">entities</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">()</span>
    <span class="n">vals_</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">,</span><span class="n">hover_value</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span> 
        <span class="n">vals_</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="c1"># get dict of uid for each entity in each level from 0...n
</span>    <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s">_</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">factorize</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">c</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s">_</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">factorize</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">c</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">cols</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">_</span><span class="sh">'</span><span class="p">].</span><span class="nf">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">entities</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">out</span><span class="p">[[</span><span class="n">cols</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">+</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">,</span><span class="n">cols</span><span class="p">[</span><span class="n">n</span><span class="p">]]].</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># create df edge list between source,targets
</span>    <span class="n">edge_list</span> <span class="o">=</span> <span class="nf">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">slice_</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">slice_</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">el_</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="nf">groupby</span><span class="p">([</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s">_</span><span class="sh">'</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">slice_</span><span class="p">],</span><span class="n">as_index</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="n">vals_</span><span class="p">].</span><span class="nf">sum</span><span class="p">()</span>
            <span class="n">el_</span><span class="p">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">target</span><span class="sh">'</span><span class="p">]</span><span class="o">+</span><span class="n">vals_</span>
            <span class="n">edge_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">el_</span><span class="p">)</span>
    <span class="n">edge_list</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="n">edge_list</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># Sankey node definitions are simply the ordered uid/names of each entity 
</span>    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">.</span><span class="nf">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span> <span class="c1"># use v[i] for name, i for uid
</span>    <span class="n">node_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">colors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">.</span><span class="nf">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>

    <span class="c1"># Sankey edge definitions
</span>    <span class="n">source</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">edge_list</span><span class="p">[</span><span class="sh">'</span><span class="s">source</span><span class="sh">'</span><span class="p">])</span>
    <span class="n">target</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">edge_list</span><span class="p">[</span><span class="sh">'</span><span class="s">target</span><span class="sh">'</span><span class="p">])</span>
    <span class="n">values</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">edge_list</span><span class="p">[</span><span class="n">values</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">hover_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">hover_values</span> <span class="o">=</span> <span class="nf">list</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hover_values</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">edge_list</span><span class="p">[</span><span class="n">hover_value</span><span class="p">])</span>

    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">==</span> <span class="nf">len</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">==</span> <span class="nf">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">==</span><span class="nf">len</span><span class="p">(</span><span class="n">hover_values</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">edge_list</span><span class="p">,</span><span class="n">entities</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">node_colors</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">values</span><span class="p">,</span><span class="n">hover_values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nc">Exception</span><span class="p">(</span><span class="sh">'</span><span class="s">Output test fail: lists are of unequal lengths</span><span class="sh">'</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">edge_list</span><span class="p">,</span><span class="n">entities</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">colors</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">values</span><span class="p">,</span><span class="n">hover_values</span> <span class="o">=</span> <span class="nf">df_2_sankey</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span><span class="n">cols</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="sh">'</span><span class="s">number_transactions</span><span class="sh">'</span><span class="p">,</span><span class="n">hover_value</span><span class="o">=</span><span class="sh">'</span><span class="s">amount_transactions</span><span class="sh">'</span><span class="p">)</span>
</pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">plotly.graph_objects</span> <span class="k">as</span> <span class="n">go</span>
<span class="kn">from</span> <span class="n">plotly.offline</span> <span class="kn">import</span> <span class="n">download_plotlyjs</span><span class="p">,</span> <span class="n">init_notebook_mode</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">iplot</span>
<span class="nf">init_notebook_mode</span><span class="p">(</span><span class="n">connected</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="p">.</span><span class="nc">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">go</span><span class="p">.</span><span class="nc">Sankey</span><span class="p">(</span>
    <span class="n">valueformat</span> <span class="o">=</span> <span class="sh">"</span><span class="s">.0f</span><span class="sh">"</span><span class="p">,</span>
    <span class="n">node</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span>
      <span class="n">pad</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
      <span class="n">thickness</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
      <span class="n">line</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="sh">"</span><span class="s">black</span><span class="sh">"</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">),</span>
      <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">,</span>
      <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">,</span>
      <span class="n">customdata</span><span class="o">=</span><span class="n">hover_values</span><span class="p">,</span>
      <span class="n">hovertemplate</span><span class="o">=</span><span class="sh">'</span><span class="s">Source: %{label}&lt;br /&gt;</span><span class="sh">'</span><span class="o">+</span>
                    <span class="sh">'</span><span class="s">Amount: %{value}&lt;br /&gt;</span><span class="sh">'</span><span class="o">+</span>
                    <span class="sh">'</span><span class="s">Transactions: %{customdata}&lt;extra&gt;&lt;/extra&gt;</span><span class="sh">'</span>
    <span class="p">),</span>
    <span class="n">link</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span>
      <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="p">,</span> <span class="c1"># indices correspond to labels, eg A1, A2, A2, B1, ...
</span>      <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">,</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">,</span>
      <span class="n">customdata</span><span class="o">=</span><span class="n">hover_values</span><span class="p">,</span>
      <span class="n">hovertemplate</span><span class="o">=</span><span class="sh">'</span><span class="s">Source: %{source.label}&lt;br /&gt;</span><span class="sh">'</span><span class="o">+</span>
                    <span class="sh">'</span><span class="s">Target: %{target.label}&lt;br /&gt;</span><span class="sh">'</span><span class="o">+</span>
                    <span class="sh">'</span><span class="s">Amount: %{value}&lt;br /&gt;</span><span class="sh">'</span><span class="o">+</span>
                    <span class="sh">'</span><span class="s">Transactions: %{customdata}&lt;extra&gt;&lt;/extra&gt;</span><span class="sh">'</span><span class="p">,</span> 
  <span class="p">))])</span>

<span class="n">fig</span><span class="p">.</span><span class="nf">update_layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span><span class="n">title_text</span><span class="o">=</span><span class="sh">"</span><span class="s">Origin &gt; Filer &gt; Beneficiary</span><span class="sh">"</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
<span class="c1"># iplot(fig,show_link=False)
</span></pre></table></code></div></div><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c1"># Output json, html or static image for web and Github
# write to html https://plotly.com/python-api-reference/generated/plotly.io.write_html.html#plotly.io.write_html
# https://plotly.com/python/renderers/
# fig.write_html('test.html')
# fig.show(renderer='svg')
</span>
<span class="kn">from</span> <span class="n">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="n">img_bytes</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">to_image</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="sh">"</span><span class="s">png</span><span class="sh">"</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="nc">Image</span><span class="p">(</span><span class="n">img_bytes</span><span class="p">)</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/images/2020-09-21-finCEN/output_23_0.png" alt="png" /></p><h1 id="references">References</h1><hr /><ul><li><a href="https://github.com/jexp/fincen">fincen data</a><li><a href="https://www.reddit.com/r/dataisbeautiful/comments/iq5ej4/energy_literacy_saul_griffiths_sankey_diagram_of/">reddit sankey of </a><li><a href="https://medium.com/kenlok/how-to-create-sankey-diagrams-from-dataframes-in-python-e221c1b4d6b0">plotly sankey helper</a><li><a href="https://numpy.org/doc/stable/reference/generated/numpy.tile.html">np.tile()</a><li><a href="https://stackoverflow.com/a/60958711/4538066">embed plotly within markdown</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blog-post/'>blog-post</a>, <a href='/categories/data-analysis/'>data-analysis</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/network-analysis/" class="post-tag no-text-decoration" >network-analysis</a> <a href="/tags/sankey-diagram/" class="post-tag no-text-decoration" >sankey-diagram</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=The finCEN files: Uncovering money laundering patterns in the global banking network - Ben Postance&url=https://bpostance.github.io/posts/finCEN/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=The finCEN files: Uncovering money laundering patterns in the global banking network - Ben Postance&u=https://bpostance.github.io/posts/finCEN/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=The finCEN files: Uncovering money laundering patterns in the global banking network - Ben Postance&url=https://bpostance.github.io/posts/finCEN/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/building-ai-enterprise/">How to build an Advanced Analytics function</a><li><a href="/posts/multi-tasking-in-python/">Multi-tasking in Python</a><li><a href="/posts/airflow-taskflow/">Writing Pythonic Airflow DAGs with the TaskFlow API</a><li><a href="/posts/finCEN/">The finCEN files: Uncovering money laundering patterns in the global banking network</a><li><a href="/posts/working-with-MODIS-data/">Geospatial Analysis: Working with MODIS data</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/bayes-theory/">bayes-theory</a> <a class="post-tag" href="/tags/bayesian-inference/">bayesian-inference</a> <a class="post-tag" href="/tags/data-mining/">data-mining</a> <a class="post-tag" href="/tags/monte-carlo/">monte carlo</a> <a class="post-tag" href="/tags/classification/">classification</a> <a class="post-tag" href="/tags/clustering/">clustering</a> <a class="post-tag" href="/tags/data-cleaning/">data-cleaning</a> <a class="post-tag" href="/tags/decomposition/">decomposition</a> <a class="post-tag" href="/tags/dimension-reduction/">dimension-reduction</a> <a class="post-tag" href="/tags/geospatial-analysis/">geospatial-analysis</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/introduction-to-bayesian-inference/"><div class="card-body"> <span class="timeago small" > Dec 13, 2020 <i class="unloaded">2020-12-13T18:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Bayesian Inference by hand</h3><div class="text-muted small"><p> image source Jupyter notebook here Bayesian inference is a statistical method used to update one’s beliefs about a process or system upon observing data. It has wide reaching applications from...</p></div></div></a></div><div class="card"> <a href="/posts/bayesian-inference-pymc3/"><div class="card-body"> <span class="timeago small" > Jan 15, 2021 <i class="unloaded">2021-01-15T18:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Bayesian Inference with PyMC3: pt 1 posterior distributions</h3><div class="text-muted small"><p> Jupyter notebook here Introduction Here we use PyMC3 on two Bayesian inference case studies: coin-toss and Insurance Claim occurrence. My last post was an introduction to Baye’s theorem and Ba...</p></div></div></a></div><div class="card"> <a href="/posts/pymc3-predictions/"><div class="card-body"> <span class="timeago small" > Feb 20, 2021 <i class="unloaded">2021-02-20T18:00:00+00:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Bayesian Inference with PyMC3: pt 2 making predictions</h3><div class="text-muted small"><p> Jupyter notebook here In this post I will show how Bayesian inference is applied to train a model and make predictions on out-of-sample test data. For this, we will build two models using a case s...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/working-with-MODIS-data/" class="btn btn-outline-primary" prompt="Older"><p>Geospatial Analysis: Working with MODIS data</p></a> <a href="/posts/introduction-to-bayesian-inference/" class="btn btn-outline-primary" prompt="Newer"><p>Bayesian Inference by hand</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//https-bpostance-github-io.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'The finCEN files: Uncovering money laundering patterns in the global banking network'; this.page.url = 'https://bpostance.github.io/posts/finCEN/'; this.page.identifier = '/posts/finCEN/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/username">BenPostance</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."> Some rights reserved. </span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/bayes-theory/">bayes theory</a> <a class="post-tag" href="/tags/bayesian-inference/">bayesian inference</a> <a class="post-tag" href="/tags/data-mining/">data mining</a> <a class="post-tag" href="/tags/monte-carlo/">monte carlo</a> <a class="post-tag" href="/tags/classification/">classification</a> <a class="post-tag" href="/tags/clustering/">clustering</a> <a class="post-tag" href="/tags/data-cleaning/">data cleaning</a> <a class="post-tag" href="/tags/decomposition/">decomposition</a> <a class="post-tag" href="/tags/dimension-reduction/">dimension reduction</a> <a class="post-tag" href="/tags/geospatial-analysis/">geospatial analysis</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://bpostance.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
